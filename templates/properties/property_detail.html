{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load i18n %}

{% block title %}{{ property.title }} - EstateAgency{% endblock %}

{% block content %}
<!-- Property Detail Main Wrapper -->
<div class="min-h-screen bg-background-light dark:bg-background-dark">
<main class="max-w-[1200px] mx-auto px-4 md:px-8 py-6 pb-20">
<!-- Breadcrumbs -->
<div class="flex items-center gap-2 text-sm text-text-muted mb-6">
<a class="hover:text-primary hover:underline" href="{% url 'properties:home' %}">{% trans "Home" %}</a>
<span class="material-symbols-outlined text-[16px]">chevron_right</span>
<a class="hover:text-primary hover:underline" href="{% url 'properties:property_list' %}">{% trans "Properties" %}</a>
<span class="material-symbols-outlined text-[16px]">chevron_right</span>
<a class="hover:text-primary hover:underline" href="{% url 'properties:property_list' %}?city={{ property.city }}">{{ property.city }}</a>
<span class="material-symbols-outlined text-[16px]">chevron_right</span>
<span class="text-text-main dark:text-white font-medium">{{ property.address }}</span>
</div>
<!-- Heading & Top Actions -->
<div class="flex flex-col lg:flex-row justify-between items-start lg:items-end gap-4 mb-6">
<div>
<div class="flex flex-wrap gap-2 mb-3">
{% if property.status == 'available' %}
<span class="px-3 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-xs font-semibold rounded-full uppercase tracking-wide">{{ property.get_status_display }}</span>
{% elif property.status == 'pending' %}
<span class="px-3 py-1 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 text-xs font-semibold rounded-full uppercase tracking-wide">{{ property.get_status_display }}</span>
{% else %}
<span class="px-3 py-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 text-xs font-semibold rounded-full uppercase tracking-wide">{{ property.get_status_display }}</span>
{% endif %}
<span class="px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 text-xs font-semibold rounded-full uppercase tracking-wide">{{ property.get_property_type_display }}</span>
{% if property.featured %}
<span class="px-3 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 text-xs font-semibold rounded-full uppercase tracking-wide">{% trans "Featured" %}</span>
{% endif %}
</div>
<h1 class="text-3xl md:text-4xl font-black text-text-main dark:text-white tracking-tight leading-tight">{{ property.title }}</h1>
<p class="text-text-muted mt-2 text-lg">{{ property.city }}{% if property.year_built %} • {% trans "Built in" %} {{ property.year_built }}{% endif %}</p>
</div>
<div class="flex gap-3">
<button class="flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-card-dark hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-sm font-medium text-text-main dark:text-white">
<span class="material-symbols-outlined text-[20px]">favorite</span>
                    {% trans "Save" %}
                </button>
<button class="flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-card-dark hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-sm font-medium text-text-main dark:text-white">
<span class="material-symbols-outlined text-[20px]">ios_share</span>
                    {% trans "Share" %}
                </button>
</div>
</div>
<!-- Image Gallery Grid -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-2 h-[400px] md:h-[500px] rounded-xl overflow-hidden mb-8 relative group">
{% if property.images.all %}
<!-- Main Hero Image -->
{% with primary_image=property.images.first %}
<div class="md:col-span-2 md:row-span-2 h-full relative cursor-pointer overflow-hidden">
<div class="absolute inset-0 bg-cover bg-center hover:scale-105 transition-transform duration-500 ease-out" style="background-image: url('{{ primary_image.image.url }}');"></div>
</div>
{% endwith %}
<!-- Secondary Images -->
{% for image in property.images.all|slice:"1:5" %}
<div class="hidden md:block h-full relative cursor-pointer overflow-hidden">
<div class="absolute inset-0 bg-cover bg-center hover:scale-105 transition-transform duration-500 ease-out" style="background-image: url('{{ image.image.url }}');"></div>
{% if forloop.last and property.images.count > 5 %}
<div class="absolute inset-0 bg-black/40 flex items-center justify-center">
<button class="bg-white/20 backdrop-blur-md border border-white/40 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-white/30 transition-all flex items-center gap-2">
<span class="material-symbols-outlined text-[18px]">grid_view</span>
                        View All {{ property.images.count }} Photos
                    </button>
</div>
{% endif %}
</div>
{% endfor %}
{% else %}
<!-- Placeholder if no images -->
<div class="md:col-span-2 md:row-span-2 h-full relative cursor-pointer overflow-hidden">
<div class="absolute inset-0 bg-gray-300 dark:bg-gray-700 flex items-center justify-center">
<span class="material-symbols-outlined text-6xl text-gray-400">home</span>
</div>
</div>
{% endif %}
</div>
<div class="grid grid-cols-1 lg:grid-cols-12 gap-10 items-start">
<!-- Left Column: Details (8 cols) -->
<div class="lg:col-span-8 flex flex-col gap-10">
<!-- Key Stats -->
<div class="flex flex-wrap items-center justify-between gap-6 p-6 bg-white dark:bg-card-dark rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm">
<div class="flex items-center gap-3">
<span class="material-symbols-outlined text-primary text-3xl">bed</span>
<div>
<p class="text-2xl font-bold text-text-main dark:text-white">{{ property.bedrooms }}</p>
<p class="text-xs font-medium text-text-muted uppercase tracking-wide">{% trans "Bedrooms" %}</p>
</div>
</div>
<div class="w-px h-10 bg-gray-200 dark:bg-gray-700"></div>
<div class="flex items-center gap-3">
<span class="material-symbols-outlined text-primary text-3xl">bathtub</span>
<div>
<p class="text-2xl font-bold text-text-main dark:text-white">{{ property.bathrooms }}</p>
<p class="text-xs font-medium text-text-muted uppercase tracking-wide">{% trans "Bathrooms" %}</p>
</div>
</div>
<div class="w-px h-10 bg-gray-200 dark:border-gray-700 hidden sm:block"></div>
<div class="flex items-center gap-3">
<span class="material-symbols-outlined text-primary text-3xl">square_foot</span>
<div>
<p class="text-2xl font-bold text-text-main dark:text-white">{{ property.area_sqm|floatformat:0 }}</p>
<p class="text-xs font-medium text-text-muted uppercase tracking-wide">{% trans "Square M" %}</p>
</div>
</div>
{% if property.parking_spaces %}
<div class="w-px h-10 bg-gray-200 dark:bg-gray-700 hidden md:block"></div>
<div class="flex items-center gap-3">
<span class="material-symbols-outlined text-primary text-3xl">garage_home</span>
<div>
<p class="text-2xl font-bold text-text-main dark:text-white">{{ property.parking_spaces }}</p>
<p class="text-xs font-medium text-text-muted uppercase tracking-wide">{% trans "Parking" %}</p>
</div>
</div>
{% endif %}
</div>
<!-- Description -->
<div>
<h3 class="text-xl font-bold text-text-main dark:text-white mb-4">{% trans "About this property" %}</h3>
<div class="prose prose-slate dark:prose-invert max-w-none text-text-main dark:text-gray-300 leading-relaxed">
{{ property.description|linebreaks }}
</div>
</div>
<!-- Property Info -->
<div>
<h3 class="text-xl font-bold text-text-main dark:text-white mb-6">{% trans "Property Information" %}</h3>
<div class="grid grid-cols-2 sm:grid-cols-3 gap-y-4 gap-x-8">
<div class="flex items-center gap-3 text-text-main dark:text-gray-300">
<span class="material-symbols-outlined text-primary">home</span>
<div>
<p class="text-xs text-text-muted">{% trans "Type" %}</p>
<p class="font-medium">{{ property.get_property_type_display }}</p>
</div>
</div>
<div class="flex items-center gap-3 text-text-main dark:text-gray-300">
<span class="material-symbols-outlined text-primary">sell</span>
<div>
<p class="text-xs text-text-muted">{% trans "Status" %}</p>
<p class="font-medium">{{ property.get_status_display }}</p>
</div>
</div>
{% if property.year_built %}
<div class="flex items-center gap-3 text-text-main dark:text-gray-300">
<span class="material-symbols-outlined text-primary">event</span>
<div>
<p class="text-xs text-text-muted">{% trans "Year Built" %}</p>
<p class="font-medium">{{ property.year_built }}</p>
</div>
</div>
{% endif %}
<div class="flex items-center gap-3 text-text-main dark:text-gray-300">
<span class="material-symbols-outlined text-primary">location_city</span>
<div>
<p class="text-xs text-text-muted">{% trans "City" %}</p>
<p class="font-medium">{{ property.city }}</p>
</div>
</div>
{% if property.postal_code %}
<div class="flex items-center gap-3 text-text-main dark:text-gray-300">
<span class="material-symbols-outlined text-primary">mail</span>
<div>
<p class="text-xs text-text-muted">{% trans "Postal Code" %}</p>
<p class="font-medium">{{ property.postal_code }}</p>
</div>
</div>
{% endif %}
<div class="flex items-center gap-3 text-text-main dark:text-gray-300">
<span class="material-symbols-outlined text-primary">square_foot</span>
<div>
<p class="text-xs text-text-muted">{% trans "Area" %}</p>
<p class="font-medium">{{ property.area_sqm }} m²</p>
</div>
</div>
</div>
</div>
<!-- Address Details -->
<div class="border-t border-gray-200 dark:border-gray-700 pt-8">
<h3 class="text-xl font-bold text-text-main dark:text-white mb-6">{% trans "Address" %}</h3>
<div class="bg-white dark:bg-card-dark rounded-lg border border-gray-200 dark:border-gray-700 p-6">
<div class="space-y-3 text-sm">
<div class="flex justify-between border-b border-dashed border-gray-200 dark:border-gray-700 pb-2">
<span class="text-text-muted">{% trans "Street Address" %}</span>
<span class="font-medium text-text-main dark:text-white">{{ property.address }}</span>
</div>
<div class="flex justify-between border-b border-dashed border-gray-200 dark:border-gray-700 pb-2">
<span class="text-text-muted">{% trans "City" %}</span>
<span class="font-medium text-text-main dark:text-white">{{ property.city }}</span>
</div>
{% if property.postal_code %}
<div class="flex justify-between border-b border-dashed border-gray-200 dark:border-gray-700 pb-2">
<span class="text-text-muted">{% trans "Postal Code" %}</span>
<span class="font-medium text-text-main dark:text-white">{{ property.postal_code }}</span>
</div>
{% endif %}
</div>
</div>
</div>
<!-- Map Section -->
<div>
<h3 class="text-xl font-bold text-text-main dark:text-white mb-4">Location</h3>
{% if property.latitude and property.longitude %}
<!-- Embedded Google Map -->
<div class="w-full h-[320px] rounded-xl overflow-hidden shadow-md border border-gray-200 dark:border-gray-700 mb-3">
<iframe
                        width="100%"
                        height="100%"
                        frameborder="0"
                        style="border:0"
                        loading="lazy"
                        referrerpolicy="no-referrer-when-downgrade"
                        src="https://www.google.com/maps?q={{ property.latitude }},{{ property.longitude }}&z=15&output=embed"
                        allowfullscreen>
</iframe>
</div>
{% else %}
<!-- Placeholder Map -->
<div class="w-full h-[320px] bg-gray-200 dark:bg-gray-700 rounded-xl relative overflow-hidden group mb-3">
<div class="absolute inset-0 flex items-center justify-center">
<div class="bg-primary text-white p-3 rounded-full shadow-lg">
<span class="material-symbols-outlined text-2xl block">location_on</span>
</div>
</div>
<div class="absolute inset-0 flex items-center justify-center pt-20">
<p class="text-text-muted text-sm">Map coordinates not available</p>
</div>
</div>
{% endif %}
<div class="flex items-center justify-between">
<p class="text-text-muted text-sm">{{ property.address }}, {{ property.city }}{% if property.postal_code %} {{ property.postal_code }}{% endif %}</p>
<a href="https://www.google.com/maps/search/?api=1&query={{ property.latitude|default:property.address|urlencode }},{{ property.longitude|default:property.city|urlencode }}" target="_blank" rel="noopener noreferrer" class="bg-primary text-white text-xs font-bold px-3 py-2 rounded-lg shadow hover:bg-blue-700 transition-all flex items-center gap-1.5">
<span class="material-symbols-outlined text-[14px]">open_in_new</span>
<span>Open in Maps</span>
</a>
</div>
</div>
</div>
<!-- Right Column: Sticky Sidebar (4 cols) -->
<div class="lg:col-span-4 relative">
<div class="sticky top-6 flex flex-col gap-6">
<!-- Pricing Card -->
<div class="bg-white dark:bg-card-dark p-6 rounded-xl border border-gray-200 dark:border-gray-700 shadow-lg">
<div class="mb-6">
<p class="text-text-muted text-sm font-medium mb-1">{% if property.status == 'sold' %}Sold Price{% else %}List Price{% endif %}</p>
<div class="flex items-baseline gap-2">
<h2 class="text-4xl font-black text-text-main dark:text-white tracking-tight">${{ property.price|floatformat:0|intcomma }}</h2>
</div>
{% if property.area_sqm %}
<p class="text-sm text-text-muted font-medium mt-1">${{ property.price|floatformat:0|intcomma }} / {{ property.area_sqm }} m²</p>
{% endif %}
</div>
{% if property.status == 'available' %}
<button class="w-full bg-primary hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition-all mb-3 flex items-center justify-center gap-2">
<span class="material-symbols-outlined">calendar_today</span>
                            Schedule a Tour
                        </button>
<button class="w-full bg-white dark:bg-gray-800 border border-primary text-primary font-bold py-3 px-4 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 transition-all flex items-center justify-center gap-2">
<span class="material-symbols-outlined">chat_bubble</span>
                            Ask a Question
                        </button>
{% else %}
<div class="w-full bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 font-bold py-3 px-4 rounded-lg text-center">
                            Property {{ property.get_status_display }}
                        </div>
{% endif %}
</div>
<!-- Agent Card -->
{% if property.agent %}
<div class="bg-white dark:bg-card-dark p-6 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm">
<div class="flex items-center gap-4 mb-6">
<div class="relative">
{% if property.agent.photo %}
<div class="w-16 h-16 rounded-full bg-gray-200 bg-cover bg-center border-2 border-white shadow-sm" style="background-image: url('{{ property.agent.photo.url }}');">
</div>
{% else %}
<div class="w-16 h-16 rounded-full bg-primary flex items-center justify-center text-white text-2xl font-bold border-2 border-white shadow-sm">
{{ property.agent.user.first_name|first }}{{ property.agent.user.last_name|first }}
</div>
{% endif %}
<div class="absolute bottom-0 right-0 w-4 h-4 bg-green-500 border-2 border-white rounded-full"></div>
</div>
<div>
<h4 class="text-lg font-bold text-text-main dark:text-white">{{ property.agent.user.get_full_name|default:property.agent.user.username }}</h4>
{% if property.agent.specialization %}
<p class="text-sm text-text-muted">{{ property.agent.specialization }}</p>
{% else %}
<p class="text-sm text-text-muted">Real Estate Agent</p>
{% endif %}
{% if property.agent.phone %}
<p class="text-xs text-text-muted mt-1">{{ property.agent.phone }}</p>
{% endif %}
</div>
</div>
<form method="post" action="{% url 'properties:contacts' %}" class="flex flex-col gap-4">
{% csrf_token %}
<input type="hidden" name="property_id" value="{{ property.id }}">
<div>
<label class="sr-only" for="name">Name</label>
<input class="w-full px-4 py-3 rounded-lg bg-background-light dark:bg-background-dark border-transparent focus:border-primary focus:ring-2 focus:ring-primary text-sm transition-colors text-text-main dark:text-white" id="name" name="name" placeholder="Your Name" type="text" required/>
</div>
<div>
<label class="sr-only" for="email">Email</label>
<input class="w-full px-4 py-3 rounded-lg bg-background-light dark:bg-background-dark border-transparent focus:border-primary focus:ring-2 focus:ring-primary text-sm transition-colors text-text-main dark:text-white" id="email" name="email" placeholder="Your Email" type="email" required/>
</div>
<div>
<label class="sr-only" for="phone">Phone</label>
<input class="w-full px-4 py-3 rounded-lg bg-background-light dark:bg-background-dark border-transparent focus:border-primary focus:ring-2 focus:ring-primary text-sm transition-colors text-text-main dark:text-white" id="phone" name="phone" placeholder="Your Phone" type="tel" required/>
</div>
<div>
<label class="sr-only" for="message">Message</label>
<textarea class="w-full px-4 py-3 rounded-lg bg-background-light dark:bg-background-dark border-transparent focus:border-primary focus:ring-2 focus:ring-primary text-sm transition-colors min-h-[100px] text-text-main dark:text-white" id="message" name="message" placeholder="I am interested in {{ property.title }}..." required></textarea>
</div>
<button class="w-full bg-primary hover:bg-primary-hover text-white font-bold py-3 px-4 rounded-lg transition-all mt-2 shadow-md" type="submit">
                                Send Message
                            </button>
</form>
</div>
{% endif %}
</div>
</div>
</div>
</main>
</div>
{% endblock %}